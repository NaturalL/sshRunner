#!/bin/bash
###################################################################
#Description  :ç™»å½•å·¥å…·
#Args         :hosts cdPath cmd [idx]
#Author       :NaturalL
#Email        :zjmove@gmail.com
###################################################################

RED='\033[4;31m'
YE='\033[0;33m'
NC='\033[0m'

runner()
{

  #åˆ†éš”è¡Œ,ä¿®æ”¹æˆ–å»æ‰
  echo -e  "\033[0;36mà¹‘Û©Û©à¹‘=============== sshRunner ===============à¹‘Û©Û©à¹‘${NC}"

  local _hosts=$1[@]
  _hosts=${!_hosts}

  local path=${2}
  local cmd=${3} #å‘½ä»¤
  local idx=${4:-"0"} #ç¬¬å‡ å°æœºå™¨


  numRe='^[0-9]+$'
  if ! [[ $idx =~ $numRe ]] ; then
    _hosts=($idx)
    idx=0 
  fi

  local i=1

  case $cmd in
    ssh)
      for host in ${_hosts}; do
        if [ $i -eq $idx ] ; then
          #å†™è®°å½•
          echo -e "`date '+%Y-%m-%d %H:%M:%S.%3N'` \t $0 \t $cmd \t $host" >> ./runner_history
          ssh -t $host "cd $path ; bash"
          exit 0
        fi
        let i=${i}+1
      done
      ;;
    info)
      for host in ${_hosts}; do
        echo -e "$i.\t${RED}$host${NC}"
        let i=${i}+1
      done
      ;;
    *)
      for host in ${_hosts}; do
        if [ "$idx" -eq 0 ] || [ $i -eq $idx ] ; then
            echo -e "${YE}$i.${NC} ğŸ–¥ï¸  ${RED}$host${YE} [`date '+%Y-%m-%d %H:%M:%S.%3N'`] ${NC}"
            if [ "$cmd" != "info" ] ; then
              #å†™è®°å½•
              echo -e "`date '+%Y-%m-%d %H:%M:%S.%3N'` \t $0 \t $cmd \t $host" >> ./runner_history
              ssh -o LogLevel=QUIET -t $host "cd $path ; $cmd 2>&1"
              #Ctrl-C ç­‰åç»­éƒ½ä¸æ‰§è¡Œ
              if [[ $? == 255 ]] ; then
                exit 255
              fi
              echo ''
            fi
        fi
        let i=${i}+1
      done
      ;;
    esac
}
